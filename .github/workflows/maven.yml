name: MorciTravel CI

on: [push]

jobs:

  morcitravel_job:
    name: Morcitravel job
    runs-on: ubuntu-latest
    #services:
    #  mongodb:
    #    image: mongo:4-bionic
    #    ports:
    #      - 27017:27017
    #    volumes:
    #      - ${{ github.workspace }}/data/mongo/001_users.js:/docker-entrypoint-initdb.d/001_users.js
    steps:
      #- name: Check out repository
      #  uses: actions/checkout@v2
      #- name: Set up JDK 13
      #  uses: actions/setup-java@v1
      #  with:
      #    java-version: 13
      #- name: Test & Package frontend
      #  run: mvn -B clean install -pl :morci-travel-frontend
      #- name: Test & Package backend
      #  run: mvn -B clean test package -pl :morci-travel-api
      - name: Kill java process
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            MORCIPID=$(/opt/prod_jdk/bin/jps -l | grep morci-travel-api-.*.jar | awk '{print $1}')
            if [ -n "$MORCIPID" ]; then kill -9 $MORCIPID; else echo 'App not running, maybe the server was restarted'; fi
#      - name: Copy jar to server
#        uses: appleboy/scp-action@master
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          password: ${{ secrets.PASSWORD }}
#          port: ${{ secrets.PORT }}
#          source: ${{ github.workspace }}/morci-travel-api/target/morci-travel-api-0.0.1.jar
#          target: "morci-travel-app"
#          strip_components: 4
      - name: Launch app
        shell: bash
        run: |
          echo "hola" > ${{ github.workspace }}/server_key.txt
          cat ${{ github.workspace }}/server_key.txt
