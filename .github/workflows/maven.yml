name: MorciTravel CI

on: [push]

jobs:

  morcitravel_job:
    name: Morcitravel job
    runs-on: ubuntu-latest
    env:
      KILL_JAVA_SH: ${{ github.workspace }}/ci/kill_java_process.sh
      SERVER_PUB_KEY: ${{ github.workspace }}/data/server/server_pub_key.txt
    #services:
    #  mongodb:
    #    image: mongo:4-bionic
    #    ports:
    #      - 27017:27017
    #    volumes:
    #      - ${{ github.workspace }}/data/mongo/001_users.js:/docker-entrypoint-initdb.d/001_users.js
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      #- name: Set up JDK 13
      #  uses: actions/setup-java@v1
      #  with:
      #    java-version: 13
      #- name: Test & Package frontend
      #  run: mvn -B clean install -pl :morci-travel-frontend
      #- name: Test & Package backend
      #  run: mvn -B clean test package -pl :morci-travel-api
      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat "$SERVER_PUB_KEY" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      - name: Kill java process
        run: |
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.PORT }} ${{ secrets.USERNAME }}@${{ secrets.HOST }} 'bash -s' < $KILL_JAVA_SH
#      - name: Copy jar to server
#        uses: appleboy/scp-action@master
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          password: ${{ secrets.PASSWORD }}
#          port: ${{ secrets.PORT }}
#          source: ${{ github.workspace }}/morci-travel-api/target/morci-travel-api-0.0.1.jar
#          target: "morci-travel-app"
#          strip_components: 4 command: /opt/prod_jdk/bin/java -jar morci-travel-app/morci-travel-api-0.0.1.jar &
      - name: Launch app
        run: |
          ssh -f -i ~/.ssh/id_rsa -p ${{ secrets.PORT }} ${{ secrets.USERNAME }}@${{ secrets.HOST }} "/opt/prod_jdk/bin/java -jar morci-travel-app/morci-travel-api-0.0.1.jar &"
